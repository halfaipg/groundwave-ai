{% extends "base.html" %}

{% block head %}
<!-- MapLibre GL JS -->
<link href="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js"></script>

<style>
    #map {
        height: calc(100vh - 220px);
        min-height: 500px;
        width: 100%;
        border-radius: 1rem;
    }
    
    /* Smooth dark theme for map container */
    .maplibregl-map {
        font-family: 'Inter', system-ui, sans-serif;
    }
    
    /* Custom popup styling */
    .maplibregl-popup-content {
        background: rgba(15, 20, 25, 0.95) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        border-radius: 12px !important;
        padding: 0 !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4) !important;
        backdrop-filter: blur(10px);
    }
    
    .maplibregl-popup-tip {
        border-top-color: rgba(15, 20, 25, 0.95) !important;
    }
    
    .maplibregl-popup-close-button {
        color: #9ca3af !important;
        font-size: 18px !important;
        padding: 4px 8px !important;
    }
    
    .maplibregl-popup-close-button:hover {
        color: white !important;
        background: transparent !important;
    }
    
    /* Control buttons */
    .maplibregl-ctrl-group {
        background: rgba(15, 20, 25, 0.9) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        border-radius: 8px !important;
        overflow: hidden;
    }
    
    .maplibregl-ctrl-group button {
        background: transparent !important;
        border: none !important;
        color: white !important;
    }
    
    .maplibregl-ctrl-group button:hover {
        background: rgba(255, 255, 255, 0.1) !important;
    }
    
    .maplibregl-ctrl-group button + button {
        border-top: 1px solid rgba(255, 255, 255, 0.1) !important;
    }
    
    .maplibregl-ctrl-group button .maplibregl-ctrl-icon {
        filter: invert(1) !important;
    }
    
    .maplibregl-ctrl-attrib {
        background: rgba(15, 20, 25, 0.7) !important;
        color: #6b7280 !important;
        font-size: 10px !important;
    }
    
    .maplibregl-ctrl-attrib a {
        color: #9ca3af !important;
    }
    
    /* Node popup */
    .node-popup {
        padding: 16px;
        min-width: 200px;
        color: white;
    }
    
    .node-popup h3 {
        margin: 0 0 4px 0;
        font-size: 15px;
        font-weight: 600;
        color: white;
    }
    
    .node-popup .node-id {
        font-family: 'SF Mono', Monaco, monospace;
        font-size: 11px;
        color: #6b7280;
        margin-bottom: 12px;
    }
    
    .node-popup .badges {
        display: flex;
        gap: 6px;
        margin-bottom: 12px;
    }
    
    .node-popup .badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .badge-online { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
    .badge-offline { background: rgba(107, 114, 128, 0.15); color: #9ca3af; }
    .badge-local { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
    .badge-regional { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
    .badge-you { background: rgba(239, 68, 68, 0.15); color: #f87171; }
    
    .node-popup .node-info {
        font-size: 12px;
        color: #d1d5db;
    }
    
    .node-popup .node-info div {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .node-popup .node-info div:last-child {
        border-bottom: none;
    }
    
    .node-popup .info-label {
        color: #6b7280;
        min-width: 70px;
    }
    
    .node-popup .info-value {
        color: #e5e7eb;
    }
    
    /* Pulse animation for your node */
    @keyframes pulse-ring {
        0% { transform: scale(1); opacity: 1; }
        100% { transform: scale(2.5); opacity: 0; }
    }
    
    .my-node-pulse {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: rgba(239, 68, 68, 0.4);
        animation: pulse-ring 2s ease-out infinite;
    }
    
    /* Custom fit bounds button */
    .fit-bounds-btn {
        background: rgba(15, 20, 25, 0.9) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        border-radius: 8px !important;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: white;
        font-size: 16px;
        transition: background 0.2s;
    }
    
    .fit-bounds-btn:hover {
        background: rgba(255, 255, 255, 0.1) !important;
    }
    
    /* Style toggle - positioned via JS as a map control */
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-white mb-2">Network Map</h1>
        <p class="text-gray-400">
            Live mesh node locations
            <span id="node-count" class="text-mesh-400 ml-1"></span>
        </p>
    </div>
    
    <!-- Hidden stat counters for JS -->
    <div id="local-count" class="hidden">0</div>
    <div id="regional-count" class="hidden">0</div>
    <div id="online-count" class="hidden">0</div>
    <div id="with-gps-count" class="hidden">0</div>
    
    <!-- Map Container -->
    <div class="glass rounded-2xl p-2 mb-4 overflow-hidden relative">
        <div id="map"></div>
    </div>
    
    <!-- Legend -->
    <div class="flex flex-wrap items-center gap-6 text-sm text-gray-400 mb-8">
        <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded-full bg-green-500 shadow-lg shadow-green-500/30"></div>
            <span>Local Mesh</span>
        </div>
        <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded-full bg-blue-500 shadow-lg shadow-blue-500/30"></div>
            <span>Regional MQTT</span>
        </div>
        <div class="flex items-center gap-2">
            <div class="relative">
                <div class="w-4 h-4 rounded-full bg-red-500 shadow-lg shadow-red-500/50"></div>
                <div class="absolute inset-0 w-4 h-4 rounded-full bg-red-500 animate-ping opacity-75"></div>
            </div>
            <span>{{ node_label or 'Your Node' }}</span>
        </div>
        <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded-full bg-gray-500 opacity-50"></div>
            <span>Offline</span>
        </div>
    </div>
    
    <!-- Network Statistics -->
    <div class="space-y-6">
        <h2 class="text-xl font-bold text-white flex items-center gap-3">
            <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            Network Statistics
        </h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Top Talkers -->
            <div class="lg:col-span-2 glass rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                        <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        Top Talkers
                        <span class="text-xs text-gray-500 font-normal ml-2">Last 24h</span>
                    </h3>
                    <span id="stat-messages-24h-badge" class="px-3 py-1 rounded-full text-xs font-medium bg-amber-500/20 text-amber-400">
                        0 msgs
                    </span>
                </div>
                
                <div id="top-talkers-container">
                    <div id="top-talkers-loading" class="flex items-center justify-center py-12 text-gray-500">
                        <svg class="animate-spin w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                            <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                        </svg>
                        Loading activity...
                    </div>
                    
                    <div id="top-talkers-empty" class="hidden text-center py-12">
                        <svg class="w-12 h-12 mx-auto text-gray-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                        <p class="text-gray-500">No message activity in the last 24 hours</p>
                        <p class="text-gray-600 text-sm mt-1">Start chatting on the mesh!</p>
                    </div>
                    
                    <div id="top-talkers-list" class="hidden space-y-2">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Stats + Hardware -->
            <div class="space-y-6">
                <!-- Quick Stats -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider mb-4">Overview</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-white/5 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                                    </svg>
                                </div>
                                <span class="text-gray-300">Total Nodes</span>
                            </div>
                            <span class="text-2xl font-bold text-white" id="stat-total-nodes">0</span>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center">
                                    <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                                </div>
                                <span class="text-gray-300">Online Now</span>
                            </div>
                            <span class="text-2xl font-bold text-green-400" id="stat-online-nodes">0</span>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                                    </svg>
                                </div>
                                <span class="text-gray-300">All Messages</span>
                            </div>
                            <span class="text-2xl font-bold text-blue-400" id="stat-total-messages">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Hardware Breakdown -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider mb-4">Hardware</h3>
                    <div id="hardware-breakdown" class="space-y-3">
                        <div class="text-gray-500 text-sm">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Config from server
    const DEFAULT_LAT = {{ default_lat }};
    const DEFAULT_LON = {{ default_lon }};
    const MY_NODE_ID = "{{ my_node_id or '' }}";
    
    // Initialize MapLibre GL map with colorful OpenStreetMap style
    const map = new maplibregl.Map({
        container: 'map',
        style: {
            version: 8,
            sources: {
                'osm': {
                    type: 'raster',
                    tiles: [
                        'https://tile.openstreetmap.org/{z}/{x}/{y}.png'
                    ],
                    tileSize: 256,
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }
            },
            layers: [{
                id: 'osm-layer',
                type: 'raster',
                source: 'osm',
                minzoom: 0,
                maxzoom: 19
            }]
        },
        center: [DEFAULT_LON, DEFAULT_LAT],
        zoom: 11,
        pitch: 0,
        bearing: 0,
        antialias: true
    });
    
    // Map styles
    const MAP_STYLES = {
        detailed: {
            version: 8,
            sources: {
                'osm': {
                    type: 'raster',
                    tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                    tileSize: 256,
                    attribution: '&copy; OpenStreetMap contributors'
                }
            },
            layers: [{ id: 'osm-layer', type: 'raster', source: 'osm', minzoom: 0, maxzoom: 19 }]
        },
        flat: {
            version: 8,
            sources: {
                'carto': {
                    type: 'raster',
                    tiles: ['https://a.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png'],
                    tileSize: 256,
                    attribution: '&copy; CARTO'
                }
            },
            layers: [{ id: 'carto-layer', type: 'raster', source: 'carto', minzoom: 0, maxzoom: 19 }]
        }
    };
    
    let currentStyle = 'detailed';
    
    function switchStyle(styleName) {
        if (styleName === currentStyle) return;
        currentStyle = styleName;
        
        // Change the base layer
        const sourceId = styleName === 'detailed' ? 'osm' : 'carto';
        const layerId = styleName === 'detailed' ? 'osm-layer' : 'carto-layer';
        
        // Remove old base layer
        if (map.getLayer('osm-layer')) map.removeLayer('osm-layer');
        if (map.getLayer('carto-layer')) map.removeLayer('carto-layer');
        if (map.getSource('osm')) map.removeSource('osm');
        if (map.getSource('carto')) map.removeSource('carto');
        
        // Add new base layer (insert at bottom)
        map.addSource(sourceId, MAP_STYLES[styleName].sources[sourceId]);
        
        // Get first layer id to insert before
        const layers = map.getStyle().layers;
        const firstLayerId = layers.length > 0 ? layers[0].id : undefined;
        
        map.addLayer({
            id: layerId,
            type: 'raster',
            source: sourceId,
            minzoom: 0,
            maxzoom: 19
        }, firstLayerId);
    }
    
    // Custom style toggle control
    class StyleToggleControl {
        onAdd(map) {
            this._map = map;
            this._container = document.createElement('div');
            this._container.className = 'maplibregl-ctrl maplibregl-ctrl-group';
            
            const button = document.createElement('button');
            button.type = 'button';
            button.title = 'Toggle map style';
            button.innerHTML = '<svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>';
            button.style.cssText = 'width: 29px; height: 29px; display: flex; align-items: center; justify-content: center; cursor: pointer;';
            button.addEventListener('click', () => {
                const newStyle = currentStyle === 'detailed' ? 'flat' : 'detailed';
                switchStyle(newStyle);
            });
            
            this._container.appendChild(button);
            return this._container;
        }
        onRemove() {
            this._container.parentNode.removeChild(this._container);
            this._map = undefined;
        }
    }
    
    // Add navigation controls (without compass)
    map.addControl(new maplibregl.NavigationControl({
        showCompass: false
    }), 'top-right');
    
    // Add scale
    map.addControl(new maplibregl.ScaleControl({
        maxWidth: 100,
        unit: 'imperial'
    }), 'bottom-left');
    
    // Add fullscreen control
    map.addControl(new maplibregl.FullscreenControl(), 'top-right');
    
    // Add style toggle control
    map.addControl(new StyleToggleControl(), 'top-right');
    
    // Stats tracking
    let stats = { local: 0, regional: 0, online: 0, withGps: 0 };
    
    // Store node data for popups
    let nodeData = {};
    
    // Format time ago
    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return 'just now';
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
        return `${Math.floor(seconds / 86400)}d ago`;
    }
    
    // Create popup HTML
    function createPopupHTML(node) {
        const isOnline = node.properties.is_online !== false;
        const isMyNode = node.properties.is_my_node;
        const source = node.properties.source;
        
        let badges = '';
        if (isMyNode) badges += '<span class="badge badge-you">You</span>';
        badges += isOnline ? '<span class="badge badge-online">Online</span>' : '<span class="badge badge-offline">Offline</span>';
        badges += source === 'local' ? '<span class="badge badge-local">Local</span>' : '<span class="badge badge-regional">Regional</span>';
        
        let info = '';
        if (node.properties.hardware) info += `<div><span class="info-label">Hardware</span><span class="info-value">${node.properties.hardware}</span></div>`;
        if (node.properties.battery_level != null) {
            const icon = node.properties.battery_level > 50 ? 'üîã' : node.properties.battery_level > 20 ? 'ü™´' : '‚ö†Ô∏è';
            info += `<div><span class="info-label">Battery</span><span class="info-value">${icon} ${node.properties.battery_level}%</span></div>`;
        }
        if (node.properties.snr != null) {
            const quality = node.properties.snr > 5 ? 'üü¢' : node.properties.snr > 0 ? 'üü°' : 'üî¥';
            info += `<div><span class="info-label">Signal</span><span class="info-value">${quality} ${node.properties.snr.toFixed(1)} dB</span></div>`;
        }
        if (node.properties.hops_away != null) info += `<div><span class="info-label">Hops</span><span class="info-value">${node.properties.hops_away}</span></div>`;
        if (node.properties.last_seen) info += `<div><span class="info-label">Last seen</span><span class="info-value">${getTimeAgo(new Date(node.properties.last_seen))}</span></div>`;
        
        return `
            <div class="node-popup">
                <h3>${node.properties.name || 'Unknown Node'}</h3>
                <div class="node-id">${node.properties.short_name ? `[${node.properties.short_name}] ` : ''}${node.properties.node_id}</div>
                <div class="badges">${badges}</div>
                ${info ? `<div class="node-info">${info}</div>` : ''}
            </div>
        `;
    }
    
    // Setup map layers when loaded
    map.on('load', () => {
        // Add GeoJSON sources for nodes
        map.addSource('local-nodes', {
            type: 'geojson',
            data: { type: 'FeatureCollection', features: [] }
        });
        
        map.addSource('regional-nodes', {
            type: 'geojson',
            data: { type: 'FeatureCollection', features: [] }
        });
        
        map.addSource('my-node', {
            type: 'geojson',
            data: { type: 'FeatureCollection', features: [] }
        });
        
        // Regional nodes - blue circles
        map.addLayer({
            id: 'regional-nodes-layer',
            type: 'circle',
            source: 'regional-nodes',
            paint: {
                'circle-radius': 8,
                'circle-color': '#3b82f6',
                'circle-stroke-color': '#ffffff',
                'circle-stroke-width': 2,
                'circle-opacity': ['case', ['get', 'is_online'], 1, 0.5]
            }
        });
        
        // Local nodes - green circles
        map.addLayer({
            id: 'local-nodes-layer',
            type: 'circle',
            source: 'local-nodes',
            paint: {
                'circle-radius': 8,
                'circle-color': '#22c55e',
                'circle-stroke-color': '#ffffff',
                'circle-stroke-width': 2,
                'circle-opacity': ['case', ['get', 'is_online'], 1, 0.5]
            }
        });
        
        // My node - red circle with glow effect (larger)
        map.addLayer({
            id: 'my-node-glow',
            type: 'circle',
            source: 'my-node',
            paint: {
                'circle-radius': 20,
                'circle-color': '#ef4444',
                'circle-opacity': 0.3,
                'circle-blur': 1
            }
        });
        
        map.addLayer({
            id: 'my-node-layer',
            type: 'circle',
            source: 'my-node',
            paint: {
                'circle-radius': 10,
                'circle-color': '#ef4444',
                'circle-stroke-color': '#ffffff',
                'circle-stroke-width': 3
            }
        });
        
        // Popup on click
        const popup = new maplibregl.Popup({
            closeButton: true,
            closeOnClick: true,
            maxWidth: '280px'
        });
        
        ['local-nodes-layer', 'regional-nodes-layer', 'my-node-layer'].forEach(layerId => {
            map.on('click', layerId, (e) => {
                const feature = e.features[0];
                popup.setLngLat(feature.geometry.coordinates)
                    .setHTML(createPopupHTML(feature))
                    .addTo(map);
            });
            
            map.on('mouseenter', layerId, () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            
            map.on('mouseleave', layerId, () => {
                map.getCanvas().style.cursor = '';
            });
        });
        
        // Initial load
        loadNodes();
    });
    
    // Convert node to GeoJSON feature
    function nodeToFeature(node, source) {
        const lat = node.latitude || (node.last_lat ? node.last_lat * 1e-7 : null);
        const lon = node.longitude || (node.last_long ? node.last_long * 1e-7 : null);
        
        if (!lat || !lon || lat === 0 || lon === 0) return null;
        
        const isMyNode = node.node_id === MY_NODE_ID || node.node_id === parseInt(MY_NODE_ID);
        
        return {
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [lon, lat] },
            properties: {
                node_id: node.node_id,
                name: node.long_name || node.short_name || 'Unknown',
                short_name: node.short_name,
                hardware: node.hardware || node.hw_model,
                battery_level: node.battery_level,
                snr: node.snr || node.last_snr,
                hops_away: node.hops_away,
                is_online: node.is_online !== false,
                is_my_node: isMyNode,
                source: source,
                last_seen: node.last_heard || node.last_seen
            }
        };
    }
    
    // Load and display all nodes
    async function loadNodes() {
        stats = { local: 0, regional: 0, online: 0, withGps: 0 };
        
        const localFeatures = [];
        const regionalFeatures = [];
        const myNodeFeatures = [];
        const bounds = new maplibregl.LngLatBounds();
        let hasValidBounds = false;
        let foundMyNode = false;
        
        // Fetch local nodes
        try {
            const response = await fetch('/api/nodes');
            if (response.ok) {
                const nodes = await response.json();
                nodes.forEach(node => {
                    stats.local++;
                    if (node.is_online) stats.online++;
                    
                    const feature = nodeToFeature(node, 'local');
                    if (feature) {
                        stats.withGps++;
                        bounds.extend(feature.geometry.coordinates);
                        hasValidBounds = true;
                        
                        if (feature.properties.is_my_node) {
                            myNodeFeatures.push(feature);
                            foundMyNode = true;
                        } else {
                            localFeatures.push(feature);
                        }
                    } else if (node.node_id === MY_NODE_ID || node.node_id === parseInt(MY_NODE_ID)) {
                        // My node without GPS - we'll add it at default location
                        foundMyNode = true;
                    }
                });
            }
        } catch (e) {
            console.error('Failed to load local nodes:', e);
        }
        
        // Fetch regional MQTT nodes
        try {
            const response = await fetch('/api/regional/nodes');
            if (response.ok) {
                const nodes = await response.json();
                nodes.forEach(node => {
                    stats.regional++;
                    
                    const feature = nodeToFeature(node, 'regional');
                    if (feature) {
                        stats.withGps++;
                        bounds.extend(feature.geometry.coordinates);
                        hasValidBounds = true;
                        regionalFeatures.push(feature);
                    }
                });
            }
        } catch (e) {
            console.log('Regional MQTT not available');
        }
        
        // Always show "your node" at default location if no GPS-equipped node found
        if (myNodeFeatures.length === 0) {
            myNodeFeatures.push({
                type: 'Feature',
                geometry: { type: 'Point', coordinates: [DEFAULT_LON, DEFAULT_LAT] },
                properties: {
                    node_id: MY_NODE_ID || 'home',
                    name: '{{ node_label }}',
                    short_name: '{{ bot_short_name or "" }}',
                    hardware: 'Home Base',
                    is_online: true,
                    is_my_node: true,
                    source: 'local',
                    no_gps: true
                }
            });
            bounds.extend([DEFAULT_LON, DEFAULT_LAT]);
            hasValidBounds = true;
        }
        
        // Update map sources
        if (map.getSource('local-nodes')) {
            map.getSource('local-nodes').setData({ type: 'FeatureCollection', features: localFeatures });
        }
        if (map.getSource('regional-nodes')) {
            map.getSource('regional-nodes').setData({ type: 'FeatureCollection', features: regionalFeatures });
        }
        if (map.getSource('my-node')) {
            map.getSource('my-node').setData({ type: 'FeatureCollection', features: myNodeFeatures });
        }
        
        // Update stats display
        document.getElementById('local-count').textContent = stats.local;
        document.getElementById('regional-count').textContent = stats.regional;
        document.getElementById('online-count').textContent = stats.online;
        document.getElementById('with-gps-count').textContent = stats.withGps;
        document.getElementById('node-count').textContent = `(${stats.withGps} of ${stats.local + stats.regional} with position)`;
        
        return { bounds, hasValidBounds };
    }
    
    // Fit map to show all nodes
    function fitToNodes(bounds, hasValidBounds) {
        if (hasValidBounds && !bounds.isEmpty()) {
            map.fitBounds(bounds, { padding: 60, maxZoom: 14, duration: 1000 });
        }
    }
    
    // Add custom fit bounds control
    class FitBoundsControl {
        onAdd(map) {
            this._map = map;
            this._container = document.createElement('div');
            this._container.className = 'maplibregl-ctrl maplibregl-ctrl-group';
            const button = document.createElement('button');
            button.type = 'button';
            button.title = 'Fit all nodes';
            button.innerHTML = '‚ä°';
            button.style.cssText = 'width: 30px; height: 30px; font-size: 18px; cursor: pointer;';
            button.addEventListener('click', async () => {
                const { bounds, hasValidBounds } = await loadNodes();
                fitToNodes(bounds, hasValidBounds);
            });
            this._container.appendChild(button);
            return this._container;
        }
        onRemove() {
            this._container.parentNode.removeChild(this._container);
            this._map = undefined;
        }
    }
    
    map.addControl(new FitBoundsControl(), 'top-right');
    
    // Auto-refresh every 60 seconds
    setInterval(loadNodes, 60000);
    
    // Handle WebSocket node updates
    function onNodeUpdate(nodeData) { loadNodes(); }
    
    // Load network statistics
    async function loadStats() {
        const loadingEl = document.getElementById('top-talkers-loading');
        const emptyEl = document.getElementById('top-talkers-empty');
        const listEl = document.getElementById('top-talkers-list');
        
        try {
            // Load summary stats
            const summaryRes = await fetch('/api/stats/summary');
            if (summaryRes.ok) {
                const summary = await summaryRes.json();
                document.getElementById('stat-total-nodes').textContent = summary.total_nodes || 0;
                document.getElementById('stat-online-nodes').textContent = summary.online_nodes || 0;
                document.getElementById('stat-total-messages').textContent = (summary.total_messages || 0).toLocaleString();
                document.getElementById('stat-messages-24h-badge').textContent = `${(summary.messages_24h || 0).toLocaleString()} msgs`;
                
                // Hardware breakdown with progress bars
                const hwBreakdown = summary.hardware_breakdown || {};
                const hwEl = document.getElementById('hardware-breakdown');
                const entries = Object.entries(hwBreakdown).sort((a, b) => b[1] - a[1]);
                const maxCount = entries.length > 0 ? entries[0][1] : 1;
                
                if (entries.length > 0) {
                    hwEl.innerHTML = entries.map(([hw, count]) => {
                        const pct = Math.round((count / maxCount) * 100);
                        const color = getHardwareColor(hw);
                        return `
                            <div class="relative">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-sm text-gray-300 truncate mr-2" title="${hw}">${hw}</span>
                                    <span class="text-sm font-semibold text-white">${count}</span>
                                </div>
                                <div class="h-2 bg-white/5 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full transition-all duration-500 ${color}" style="width: ${pct}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    hwEl.innerHTML = '<div class="text-gray-500 text-sm">No hardware data yet</div>';
                }
            }
            
            // Load top talkers
            const topRes = await fetch('/api/stats/top?limit=10');
            if (topRes.ok) {
                const topData = await topRes.json();
                
                loadingEl.classList.add('hidden');
                
                if (topData.nodes && topData.nodes.length > 0) {
                    emptyEl.classList.add('hidden');
                    listEl.classList.remove('hidden');
                    
                    const maxMsgs = topData.nodes[0].message_count || 1;
                    
                    listEl.innerHTML = topData.nodes.map((node, idx) => {
                        const pct = Math.round((node.message_count / maxMsgs) * 100);
                        const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `#${idx + 1}`;
                        const isTop3 = idx < 3;
                        
                        return `
                            <div class="group relative p-3 rounded-xl hover:bg-white/5 transition">
                                <div class="flex items-center gap-4">
                                    <div class="flex-shrink-0 w-8 text-center ${isTop3 ? 'text-lg' : 'text-sm text-gray-500'}">
                                        ${medal}
                                    </div>
                                    <div class="flex-grow min-w-0">
                                        <div class="flex items-center gap-2">
                                            <span class="font-medium text-white truncate">${node.name || 'Unknown'}</span>
                                            ${node.short_name ? `<span class="text-xs text-gray-500">[${node.short_name}]</span>` : ''}
                                            ${node.is_online 
                                                ? '<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>'
                                                : '<span class="w-2 h-2 rounded-full bg-gray-600"></span>'}
                                        </div>
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="text-xs text-gray-500 font-mono">${node.node_id}</span>
                                            ${node.hardware ? `<span class="text-xs text-gray-600">‚Ä¢</span><span class="text-xs text-gray-500">${node.hardware}</span>` : ''}
                                        </div>
                                        <div class="mt-2 h-1.5 bg-white/5 rounded-full overflow-hidden">
                                            <div class="h-full bg-gradient-to-r from-amber-500 to-orange-500 rounded-full transition-all duration-700" style="width: ${pct}%"></div>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 text-right">
                                        <div class="text-lg font-bold text-amber-400">${node.message_count}</div>
                                        <div class="text-xs text-gray-500">msgs</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    emptyEl.classList.remove('hidden');
                    listEl.classList.add('hidden');
                }
            }
        } catch (e) {
            console.error('Failed to load stats:', e);
            loadingEl.classList.add('hidden');
            emptyEl.classList.remove('hidden');
            emptyEl.querySelector('p').textContent = 'Failed to load statistics';
        }
    }
    
    // Get color for hardware type
    function getHardwareColor(hw) {
        const hwLower = (hw || '').toLowerCase();
        if (hwLower.includes('tbeam')) return 'bg-purple-500';
        if (hwLower.includes('heltec')) return 'bg-blue-500';
        if (hwLower.includes('rak')) return 'bg-green-500';
        if (hwLower.includes('lora')) return 'bg-cyan-500';
        if (hwLower.includes('tdeck') || hwLower.includes('t-deck')) return 'bg-pink-500';
        if (hwLower.includes('nano')) return 'bg-yellow-500';
        if (hwLower.includes('station')) return 'bg-red-500';
        return 'bg-gray-500';
    }
    
    // Load stats on page load and refresh every 60 seconds
    loadStats();
    setInterval(loadStats, 60000);
</script>
{% endblock %}
